<!DOCTYPE html>
<html>
<head>
    <title>Тест симуляции очереди</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
        #simulation {
            border: 2px solid #333;
            background: white;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Тест симуляции очереди к врачам</h1>
    <div class="controls">
        <button onclick="startSimulation()">Старт</button>
        <button onclick="stopSimulation()">Стоп</button>
        <button onclick="stepSimulation()">Шаг</button>
        <button onclick="resetSimulation()">Сброс</button>
    </div>
    <div id="simulation"></div>

    <script src="js/lib/pixi.min.js"></script>
    <script src="js/lib/tweenjs-0.6.2.min.js"></script>
    <script>
        // Простая версия симуляции для тестирования
        class QueueSimulationTest {
            constructor() {
                this.app = new PIXI.Application(800, 500, {backgroundColor: 0xffffff});
                document.getElementById('simulation').appendChild(this.app.view);

                this.waitingPatients = [];
                this.doctors = [];
                this.currentStep = 0;
                this.isAutoPlaying = false;
                this.autoPlayInterval = null;

                this.initDoctors();
            }

            initDoctors() {
                // Создаем 2 врача
                for(let i = 0; i < 2; i++) {
                    const doctor = {
                        graphics: this.createDoctor(600, 100 + i * 120),
                        isBusy: false,
                        currentPatient: null,
                        serviceTimeRemaining: 0
                    };
                    this.doctors.push(doctor);
                }
            }

            createDoctor(x, y) {
                const graphics = new PIXI.Graphics();
                graphics.beginFill(0x0000FF); // Синий цвет для врача
                graphics.drawCircle(0, 0, 20);
                graphics.endFill();
                graphics.x = x;
                graphics.y = y;
                this.app.stage.addChild(graphics);
                return graphics;
            }

            createPatient() {
                const graphics = new PIXI.Graphics();
                graphics.beginFill(0xFF0000); // Красный цвет для пациента
                graphics.drawCircle(0, 0, 15);
                graphics.endFill();
                graphics.x = 100 + this.waitingPatients.length * 60;
                graphics.y = 400;
                this.app.stage.addChild(graphics);
                return graphics;
            }

            step() {
                this.currentStep++;

                // Добавление нового пациента с вероятностью 30%
                if(Math.random() < 0.3) {
                    const patient = {
                        graphics: this.createPatient(),
                        waitingTime: 0
                    };
                    this.waitingPatients.push(patient);
                }

                // Обслуживание пациентов врачами
                for(const doctor of this.doctors) {
                    if(doctor.isBusy) {
                        doctor.serviceTimeRemaining--;
                        if(doctor.serviceTimeRemaining <= 0) {
                            this.completeService(doctor);
                        }
                    } else {
                        if(this.waitingPatients.length > 0) {
                            this.startService(doctor, this.waitingPatients.shift());
                            this.updatePatientPositions();
                        }
                    }
                }

                // Обновление времени ожидания
                for(const patient of this.waitingPatients) {
                    patient.waitingTime++;
                }

                console.log(`Шаг: ${this.currentStep}, Пациентов в очереди: ${this.waitingPatients.length}`);
            }

            startService(doctor, patient) {
                doctor.isBusy = true;
                doctor.currentPatient = patient;
                doctor.serviceTimeRemaining = Math.max(1, Math.round(3 * (0.5 + Math.random())));

                // Анимация перемещения пациента к врачу
                createjs.Tween.get(patient.graphics)
                    .to({x: doctor.graphics.x - 50, y: doctor.graphics.y}, 500);
            }

            completeService(doctor) {
                if(doctor.currentPatient) {
                    this.app.stage.removeChild(doctor.currentPatient.graphics);
                    doctor.currentPatient = null;
                }
                doctor.isBusy = false;
                doctor.serviceTimeRemaining = 0;
            }

            updatePatientPositions() {
                for(let i = 0; i < this.waitingPatients.length; i++) {
                    this.waitingPatients[i].graphics.x = 100 + i * 60;
                }
            }

            startAutoPlay() {
                this.isAutoPlaying = true;
                this.autoPlayInterval = setInterval(() => this.step(), 1000);
            }

            stopAutoPlay() {
                this.isAutoPlaying = false;
                if(this.autoPlayInterval) {
                    clearInterval(this.autoPlayInterval);
                }
            }

            reset() {
                this.stopAutoPlay();

                // Очистка пациентов
                for(const patient of this.waitingPatients) {
                    this.app.stage.removeChild(patient.graphics);
                }
                this.waitingPatients = [];

                // Сброс врачей
                for(const doctor of this.doctors) {
                    doctor.isBusy = false;
                    doctor.serviceTimeRemaining = 0;
                    if(doctor.currentPatient) {
                        this.app.stage.removeChild(doctor.currentPatient.graphics);
                        doctor.currentPatient = null;
                    }
                }

                this.currentStep = 0;
            }
        }

        let simulation;

        function startSimulation() {
            if(!simulation) {
                simulation = new QueueSimulationTest();
            }
            simulation.startAutoPlay();
        }

        function stopSimulation() {
            if(simulation) {
                simulation.stopAutoPlay();
            }
        }

        function stepSimulation() {
            if(!simulation) {
                simulation = new QueueSimulationTest();
            }
            simulation.step();
        }

        function resetSimulation() {
            if(simulation) {
                simulation.reset();
            }
        }
    </script>
</body>
</html>
